#!/bin/bash

# edugo-dev-environment - Pre-commit Hook
# Valida docker-compose.yml antes de permitir commit

# Colores
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}üîç Ejecutando validaciones pre-commit...${NC}"
echo ""

# Validar docker-compose.yml si fue modificado
if git diff --cached --name-only | grep -q "docker/docker-compose.*\.yml"; then
    echo -e "${BLUE}üìù Archivos docker-compose modificados, validando...${NC}"

    # Ejecutar script de validaci√≥n
    if ! ./scripts/validate.sh > /dev/null 2>&1; then
        echo ""
        echo -e "${RED}‚ùå Validaci√≥n de docker-compose fall√≥. Commit bloqueado.${NC}"
        echo ""
        echo "Detalles del error:"
        ./scripts/validate.sh 2>&1 | tail -20
        echo ""
        echo "Soluciones:"
        echo "  1. Corregir errores en archivos docker-compose"
        echo "  2. Ejecutar: ./scripts/validate.sh (para ver detalles)"
        echo "  3. Omitir validaci√≥n: git commit --no-verify (NO recomendado)"
        exit 1
    fi

    echo ""
    echo -e "${GREEN}‚úÖ docker-compose v√°lido${NC}"
fi

# Validar que .env no se commitee
if git diff --cached --name-only | grep -q "^docker/\.env$"; then
    echo ""
    echo -e "${RED}‚ö†Ô∏è  ADVERTENCIA: Intentando commitear docker/.env${NC}"
    echo ""
    echo "El archivo .env contiene credenciales y NO debe commitearse."
    echo ""
    echo "Soluciones:"
    echo "  1. git reset HEAD docker/.env"
    echo "  2. Verificar que docker/.env est√© en .gitignore"
    echo "  3. Omitir validaci√≥n: git commit --no-verify (NO recomendado)"
    exit 1
fi

# Validar que archivos de credenciales no se commiteen
CREDENTIAL_FILES=(
    ".env"
    ".env.local"
    ".env.production"
    "credentials.json"
    "serviceAccount.json"
)

for file in "${CREDENTIAL_FILES[@]}"; do
    if git diff --cached --name-only | grep -qE "(^|/)$file\$"; then
        echo ""
        echo -e "${RED}‚ö†Ô∏è  ADVERTENCIA: Intentando commitear $file${NC}"
        echo ""
        echo "Este archivo contiene informaci√≥n sensible y NO debe commitearse."
        echo ""
        echo "Soluciones:"
        echo "  1. git reset HEAD $file"
        echo "  2. Verificar que est√© en .gitignore"
        echo "  3. Omitir validaci√≥n: git commit --no-verify (solo si est√°s seguro)"
        exit 1
    fi
done

# Validar scripts tienen permisos de ejecuci√≥n
MODIFIED_SCRIPTS=$(git diff --cached --name-only | grep "^scripts/.*\.sh$")
if [ -n "$MODIFIED_SCRIPTS" ]; then
    echo -e "${BLUE}üîß Verificando permisos de scripts...${NC}"

    for script in $MODIFIED_SCRIPTS; do
        if [ ! -x "$script" ]; then
            echo -e "${YELLOW}‚ö†Ô∏è  Script $script no es ejecutable${NC}"
            echo "Agregando permisos de ejecuci√≥n..."
            chmod +x "$script"
            git add "$script"
        fi
    done

    echo -e "${GREEN}‚úÖ Permisos de scripts correctos${NC}"
fi

echo ""
echo -e "${GREEN}‚úÖ Todas las validaciones pasaron${NC}"
exit 0
