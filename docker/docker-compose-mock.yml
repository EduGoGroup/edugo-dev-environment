# ========================================
# DOCKER COMPOSE - MODO MOCK (Sin Infraestructura)
# ========================================
# Este archivo levanta las APIs de EduGo en modo MOCK:
# - NO requiere PostgreSQL, MongoDB ni RabbitMQ
# - Usa repositorios en memoria con datos de prueba precargados
# - Ideal para frontend developers que solo necesitan APIs funcionando
# - Startup ultra-rápido (~3 segundos)
#
# BENEFICIOS:
# - Ahorra ~1.2GB de RAM (sin bases de datos)
# - No requiere configuración de infraestructura
# - Datos consistentes y predecibles
# - Funciona en cualquier máquina sin setup previo
#
# LIMITACIONES:
# - Los datos NO persisten (se reinician con cada restart)
# - Sin transacciones reales
# - Worker NO está disponible en modo mock (requiere RabbitMQ + OpenAI)
# - Solo para desarrollo/diseño, NO para testing de integración
#
# Uso:
#   docker-compose -f docker-compose-mock.yml up -d
#   docker-compose -f docker-compose-mock.yml down
#
# Verificar salud:
#   curl http://localhost:8081/health  # api-mobile
#   curl http://localhost:8082/health  # api-admin
#
# Login de prueba:
#   curl -X POST http://localhost:8082/v1/auth/login \
#     -H "Content-Type: application/json" \
#     -d '{"email": "admin@edugo.test", "password": "edugo2024"}'

name: edugo-mock

services:
  # ========================================
  # API MOBILE (MOCK MODE)
  # ========================================
  api-mobile:
    image: ghcr.io/edugogroup/edugo-api-mobile:${API_MOBILE_VERSION:-latest}
    container_name: edugo-api-mobile-mock
    ports:
      - "${API_MOBILE_PORT:-8081}:8080"
    # Ejecutar binario directamente, saltando el entrypoint que espera servicios
    entrypoint: ["/root/main"]
    working_dir: /root
    environment:
      # ============================================
      # MODO MOCK - Variable que activa bifurcación
      # ============================================
      - USE_MOCK_REPOSITORIES=true

      # Configuración de ambiente
      - APP_ENV=${APP_ENV:-development}
      - ENV=${ENV:-development}
      - PORT=8080

      # Variables directamente bindeadas (valores dummy para pasar validación)
      - DATABASE_POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-mock-not-used}
      - DATABASE_MONGODB_URI=mongodb://mock:mock@mock-not-used:27017/mock?authSource=admin
      - MESSAGING_RABBITMQ_URL=amqp://mock:mock@mock-not-used:5672/
      - STORAGE_S3_ACCESS_KEY_ID=${S3_ACCESS_KEY:-AKIAIOSFODNN7EXAMPLE}
      - STORAGE_S3_SECRET_ACCESS_KEY=${S3_SECRET_KEY:-wJalrXUtnFEMI/K7MDENG/bPxRfiCYEXAMPLEKEY}
      - AUTH_JWT_SECRET=${JWT_SECRET:-dev-secret-key-change-in-production}

      # Base de datos PostgreSQL (valores dummy)
      - DATABASE_POSTGRES_HOST=mock-not-used
      - DATABASE_POSTGRES_PORT=5432
      - DATABASE_POSTGRES_USER=${POSTGRES_USER:-mock}
      - DATABASE_POSTGRES_DATABASE=${POSTGRES_DB:-mock}
      - DATABASE_POSTGRES_SSLMODE=disable
      - DATABASE_POSTGRES_MAX_CONNECTIONS=25

      # Base de datos MongoDB (valores dummy)
      - DATABASE_MONGODB_DATABASE=${MONGO_DB:-mock}
      - DATABASE_MONGODB_TIMEOUT=10s

      # Mensajería RabbitMQ (valores dummy)
      - MESSAGING_RABBITMQ_PREFETCH_COUNT=1
      - MESSAGING_RABBITMQ_QUEUES_MATERIAL_UPLOADED=material.uploaded
      - MESSAGING_RABBITMQ_QUEUES_ASSESSMENT_ATTEMPT=assessment.attempt
      - MESSAGING_RABBITMQ_EXCHANGES_MATERIALS=materials

      # Almacenamiento S3 (valores dummy)
      - STORAGE_S3_BUCKET_NAME=${S3_BUCKET:-edugo-materials-dev-local}
      - STORAGE_S3_REGION=${S3_REGION:-us-east-1}
      - STORAGE_S3_ENDPOINT=${S3_ENDPOINT:-}

      # Recursos opcionales (Bootstrap) - Marcar como opcionales
      - BOOTSTRAP_OPTIONAL_RESOURCES_S3=${BOOTSTRAP_OPTIONAL_RESOURCES_S3:-true}
      - BOOTSTRAP_OPTIONAL_RESOURCES_RABBITMQ=${BOOTSTRAP_OPTIONAL_RESOURCES_RABBITMQ:-true}

      # Servidor
      - SERVER_PORT=8080
      - SERVER_HOST=0.0.0.0
      - SERVER_READ_TIMEOUT=30s
      - SERVER_WRITE_TIMEOUT=30s

      # Logging
      - LOGGING_LEVEL=${LOG_LEVEL:-debug}
      - LOGGING_FORMAT=${LOG_FORMAT:-json}

    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:8080/health",
        ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    networks:
      - edugo-mock-network
    restart: unless-stopped

  # ========================================
  # API ADMINISTRACIÓN (MOCK MODE)
  # ========================================
  api-administracion:
    image: ghcr.io/edugogroup/edugo-api-administracion:${API_ADMIN_VERSION:-latest}
    container_name: edugo-api-administracion-mock
    ports:
      - "${API_ADMIN_PORT:-8082}:8081"
    environment:
      # ============================================
      # MODO MOCK - Variable que activa bifurcación
      # ============================================
      - USE_MOCK_REPOSITORIES=true

      # Configuración de ambiente
      - APP_ENV=${APP_ENV:-development}
      - ENV=${ENV:-development}

      # Variables directamente bindeadas (valores dummy para pasar validación)
      - POSTGRES_PASSWORD=${POSTGRES_PASSWORD:-mock-not-used}
      - MONGODB_URI=mongodb://mock:mock@mock-not-used:27017/mock?authSource=admin
      - AUTH_JWT_SECRET=${JWT_SECRET:-dev-secret-key-change-in-production}

      # Variables con prefijo EDUGO_ADMIN_ (Viper las lee con AutomaticEnv)
      - EDUGO_ADMIN_SERVER_PORT=8081
      - EDUGO_ADMIN_SERVER_HOST=0.0.0.0
      - EDUGO_ADMIN_SERVER_READ_TIMEOUT=30s
      - EDUGO_ADMIN_SERVER_WRITE_TIMEOUT=30s

      - EDUGO_ADMIN_DATABASE_POSTGRES_HOST=mock-not-used
      - EDUGO_ADMIN_DATABASE_POSTGRES_PORT=5432
      - EDUGO_ADMIN_DATABASE_POSTGRES_USER=${POSTGRES_USER:-mock}
      - EDUGO_ADMIN_DATABASE_POSTGRES_DATABASE=${POSTGRES_DB:-mock}
      - EDUGO_ADMIN_DATABASE_POSTGRES_SSLMODE=disable
      - EDUGO_ADMIN_DATABASE_POSTGRES_MAX_CONNECTIONS=25

      - EDUGO_ADMIN_DATABASE_MONGODB_DATABASE=${MONGO_DB:-mock}
      - EDUGO_ADMIN_DATABASE_MONGODB_TIMEOUT=10s

      - EDUGO_ADMIN_LOGGING_LEVEL=${LOG_LEVEL:-debug}
      - EDUGO_ADMIN_LOGGING_FORMAT=${LOG_FORMAT:-json}

    healthcheck:
      test:
        [
          "CMD",
          "wget",
          "--no-verbose",
          "--tries=1",
          "--spider",
          "http://localhost:8081/health",
        ]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 5s
    networks:
      - edugo-mock-network
    restart: unless-stopped

networks:
  edugo-mock-network:
    driver: bridge
